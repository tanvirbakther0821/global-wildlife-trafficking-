<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <!-- add title -->
    <title>Wildlife Trafficking Choropleth Map</title>

    <!-- import required libraries here -->
    <script src="lib/d3.v5.min.js"></script>
    <script src="lib/topojson.v2.min.js"></script>
    <script src="lib/d3-tip.min.js"></script>
    <script src="lib/d3-legend.min.js"></script>
    <script src="lib/d3-geo-projection.v2.min.js"></script>
    <style>
        /* define CSS rules here */
        body {
            background-color: #F2F3F6;
            min-height: 100%;
            font-family: "Verdana", sans-serif;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            text-align: center;
        }

        #dropdown-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #yearDropdown {
            padding: 5px 10px;
            font-size: 14px;
        }

        #legend {
            font-size: 0.7em;
            letter-spacing: 0.1;
        }

        .map {
            padding: 20px;
            background-color: #FFFFFF;
            border: 1px solid #4D8DC4;
            box-shadow: 1px 1px 15px #000000;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .country {
            stroke: #fff;
            stroke-width: 0.5px;
        }

        .country:hover {
            stroke: #333;
            stroke-width: 2px;
        }

        div.tooltip {   
            position: absolute;
            padding: 7px;
            font-size: 0.8em;
            pointer-events: none;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
        }

        .d3-tip {
            line-height: 1.5;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
        }

        .background {
            fill: transparent;
            pointer-events: all;
        }

        .world {
            transform-origin: center;
        }

        .legendQuant {
            font-size: 12px;
        }

        #username {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="map">
        <!-- Add heading for the visualization -->
        <h1>Wildlife Trafficking Incidents by Country</h1>

        <!-- Create dropdown element here. Options should be added after reading in wildlife_trafficking file, they should not be created here.-->
        <div id="dropdown-container">
            <label for="yearDropdown">Select Year: </label>
            <select id="yearDropdown"></select>
        </div>

        <!-- SVG will be appended here by D3 -->
        
        <!-- Display GT username beneath the map -->
        <div id="username">GT Username: tbakther3</div>
    </div>

    <script>

        // enter code to define margin and dimensions for svg
        const margin = {top: 10, right: 10, bottom: 10, left: 10};
        const width = 960 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;

        // enter code to create svg with id="choropleth"
        const svg = d3.select(".map")
            .append("svg")
            .attr("id", "choropleth")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // enter code to create color scale
        let colorScale;

        // enter code to define tooltip
        const tip = d3.tip()
            .attr('class', 'd3-tip')
            .attr('id', 'tooltip')
            .offset([-10, 0])
            .html(function(d) {
                return d;
            });

        svg.call(tip);

        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"
        const projection = d3.geoNaturalEarth1()
            .scale(150)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        // define any other global variables
        let traffickingData = [];
        let allYears = [];
        let worldData;

        Promise.all([
            // enter code to read files
            d3.json("data/world_countries.json"),
            d3.csv("data/wildlife_trafficking.csv", function(d) {
                return {
                    year: +d.Year,
                    country: d["Country of Incident"],
                    incidents: +d.Number_of_Incidents,
                    avgFine: +d.Average_Fine,
                    avgImprisonment: +d.Average_Imprisonment
                };
            })
        ]).then(function(values) {
            // Store the GeoJSON data
            worldData = values[0];
            
            // Store trafficking data
            traffickingData = values[1];

            // Get unique years and sort them
            allYears = Array.from(new Set(traffickingData.map(d => d.year))).sort((a, b) => a - b);

            // Append years to dropdown
            const dropdown = d3.select("#yearDropdown");
            dropdown.selectAll("option")
                .data(allYears)
                .enter()
                .append("option")
                .text(d => d)
                .attr("value", d => d);

            // Set default year (first option)
            const defaultYear = allYears[0];
            dropdown.property("value", defaultYear);

            // Event listener for the dropdown
            dropdown.on("change", function() {
                const selectedYear = +this.value;
                createMapAndLegend(worldData, traffickingData, selectedYear);
            });

            // Create initial map with default year
            createMapAndLegend(worldData, traffickingData, defaultYear);
        });

        // this function should create a Choropleth and legend using the world and traffickingData arguments for a selectedYear
        function createMapAndLegend(world, data, selectedYear) {
            // Filter data for selected year
            const yearData = data.filter(d => d.year === selectedYear);

            // Create a map of country to data
            const countryData = {};
            yearData.forEach(d => {
                countryData[d.country] = {
                    incidents: d.incidents,
                    avgFine: d.avgFine,
                    avgImprisonment: d.avgImprisonment
                };
            });

            // Get all incident values for this year to create quantile scale
            const incidentValues = yearData.map(d => d.incidents).filter(d => !isNaN(d));

            // Create quantile scale with 4 color gradations (darker = more incidents)
            if (incidentValues.length > 0) {
                colorScale = d3.scaleQuantile()
                    .domain(incidentValues)
                    .range(['#fee5d9', '#fcae91', '#fb6a4a', '#cb181d']);
            }

            // Remove existing map and legend
            svg.selectAll("#countries").remove();
            svg.selectAll("#legend").remove();

            // Create a group for countries with id="countries"
            const countriesGroup = svg.append("g")
                .attr("id", "countries");

            // Draw the map
            countriesGroup.selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", function(d) {
                    const countryName = d.properties.name;
                    if (countryData[countryName] && countryData[countryName].incidents !== undefined) {
                        return colorScale(countryData[countryName].incidents);
                    }
                    return "#ccc"; // Gray for no data
                })
                .on("mouseover", function(d) {
                    const countryName = d.properties.name;
                    let tooltipHtml = `<strong>${countryName}</strong><br/>`;
                    tooltipHtml += `Year: ${selectedYear}<br/>`;

                    if (countryData[countryName]) {
                        tooltipHtml += `Number of Incidents: ${countryData[countryName].incidents}<br/>`;
                        tooltipHtml += `Average Fine: $${countryData[countryName].avgFine.toFixed(2)}<br/>`;
                        tooltipHtml += `Average Imprisonment: ${countryData[countryName].avgImprisonment.toFixed(2)} years`;
                    } else {
                        tooltipHtml += `Number of Incidents: N/A<br/>`;
                        tooltipHtml += `Average Fine: N/A<br/>`;
                        tooltipHtml += `Average Imprisonment: N/A`;
                    }

                    tip.show(tooltipHtml, this);
                })
                .on("mouseout", function(d) {
                    tip.hide();
                });

            // Create legend with proper formatting
            if (incidentValues.length > 0) {
                const legend = d3.legendColor()
                    .labelFormat(d3.format(".2f"))
                    .scale(colorScale)
                    .shapePadding(5)
                    .shapeWidth(30)
                    .shapeHeight(20)
                    .labelOffset(10);

                svg.append("g")
                    .attr("id", "legend")
                    .attr("class", "legendQuant")
                    .attr("transform", `translate(${width - 120}, ${height - 200})`)
                    .call(legend);
            }
        }
    </script>
</body>

</html>
